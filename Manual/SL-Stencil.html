<!DOCTYPE html><html lang="en" class="no-js">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unity - Manual: ShaderLab: Stencil</title>
<meta name="description" content="Develop once, publish everywhere! Unity is the ultimate tool for video game development, architectural visualizations, and interactive media installations - publish to the web, Windows, OS X, Wii, Xbox 360, and iPhone with many more platforms to come.">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="../StaticFilesManual/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFilesManual/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFilesManual/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFilesManual/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFilesManual/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFilesManual/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFilesManual/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFilesManual/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFilesManual/images/favicons/tileicon-144x144.png">
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2854981-1']);
  _gaq.push(['_setDomainName', 'unity3d.com']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script><script type="text/javascript" src="../StaticFilesManual/js/jquery.js"></script><script type="text/javascript" src="../StaticFilesManual/js/core.js"></script><script type="text/javascript" src="../StaticFilesManual/js/highlight.js"></script><script type="text/javascript" src="docdata/toc.js"></script><script type="text/javascript" src="docdata/global_toc.js"></script><script>hljs.initHighlightingOnLoad();</script><link href="http://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../StaticFilesManual/css/core.css">
</head>
<body>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div class="logo"><a href="http://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul>
<li><a href="http://docs.unity3d.com">Overview</a></li>
<li><a href="../Manual/index.html" class="selected">Manual</a></li>
<li><a href="../ScriptReference/index.html">Scripting API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="http://unity3d.com/">unity3d.com</a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content"><div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">Language: <span class="b">English</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a href="/Manual/SL-Stencil.html">English</a></li>
<li><a href="/es/current/Manual/SL-Stencil.html">Español</a></li>
<li><a href="/ru/current/Manual/SL-Stencil.html">Русский</a></li>
</ul></div>
</div></div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc"><h2>Unity Manual</h2></div></div></div></div></div>
<div id="content-wrap" class="content-wrap"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManualRestructured.html">Unity Manual</a></li>
<li><a href="Graphics.html">Graphics</a></li>
<li><a href="GraphicsReference.html">Graphics Reference</a></li>
<li><a href="SL-Reference.html"> Shader Reference</a></li>
<li><a href="SL-Shader.html">ShaderLab Syntax</a></li>
<li><a href="SL-SubShader.html">ShaderLab: SubShader</a></li>
<li><a href="SL-Pass.html">ShaderLab: Pass</a></li>
<li>ShaderLab: Stencil</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="SL-PassTags.html"></a></span><div class="tip">ShaderLab: Pass Tags</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="SL-Fog.html"></a></span><div class="tip">ShaderLab: Fog</div>
</div>
</div></div>
<h1>ShaderLab: Stencil</h1>
  		        <div class="suggest">
                <a class="blue-btn sbtn">Suggest a change</a>
                <div class="suggest-wrap rel hide">
                  <div class="loading hide">
<div></div>
<div></div>
<div></div>
</div>
                  <div class="suggest-success hide">
                    <h2>Success!</h2>
                    <p>Thank you for helping us improve the quality of Unity Documentation. Although we cannot accept all submissions, we do read each suggested change from our users and will make updates where applicable.</p>
                    <a class="gray-btn sbtn close">Close</a>
                  </div>
                  <div class="suggest-failed hide">
                    <h2>Sumbission failed</h2>
                    <p>For some reason your suggested change could not be submitted. Please <a>try again</a> in a few minutes. And thank you for taking the time to help us improve the quality of Unity Documentation.</p>
                    <a class="gray-btn sbtn close">Close</a>
                  </div>
                  <div class="suggest-form clear">
                    <label for="suggest_name">Your name</label>
                    <input id="suggest_name" type="text">
                    <label for="suggest_email">Your email</label>
                    <input id="suggest_email" type="email">
                    <label for="suggest_body" class="clear">Suggestion <span class="r">*</span></label>
                    <textarea id="suggest_body" class="req"></textarea>
                    <button id="suggest_submit" class="blue-btn mr10">Submit suggestion</button>
                    <p class="mb0"><a class="cancel left lh42 cn">Cancel</a></p>
                  </div>
                </div>
              </div>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>The stencil buffer can be used as a general purpose per pixel mask for saving or discarding pixels.</p>

<p>The stencil buffer is usually an 8 bit integer per pixel. The value can be written to, increment or decremented. Subsequent draw calls can test against the value, to decide if a pixel should be discarded before running the pixel shader.</p>

<h2>Syntax</h2>

<h3>Ref</h3>

<pre><code>    Ref referenceValue
</code></pre>

<p>The value to be compared against (if Comp is anything else than <em>always</em>) and/or the value to be written to the buffer (if either Pass, Fail or ZFail is set to replace). 0–255 integer.</p>

<h3>ReadMask</h3>

<pre><code>    ReadMask readMask
</code></pre>

<p>An 8 bit mask as an 0–255 integer, used when comparing the reference value with the contents of the buffer (<em>referenceValue</em> &amp; <em>readMask</em>) <em>comparisonFunction</em> (<em>stencilBufferValue</em> &amp; <em>readMask</em>). Default: <em>255</em>.</p>

<h3>WriteMask</h3>

<pre><code>    WriteMask writeMask
</code></pre>

<p>An 8 bit mask as an 0–255 integer, used when writing to the buffer. Default: <em>255</em>.</p>

<h3>Comp</h3>

<pre><code>    Comp comparisonFunction
</code></pre>

<p>The function used to compare the reference value to the current contents of the buffer. Default: <em>always</em>.</p>

<h3>Pass</h3>

<pre><code>    Pass stencilOperation
</code></pre>

<p>What to do with the contents of the buffer if the stencil test (and the depth test) passes. Default: <em>keep</em>.</p>

<h3>Fail</h3>

<pre><code>    Fail stencilOperation
</code></pre>

<p>What to do with the contents of the buffer if the stencil test fails. Default: <em>keep</em>.</p>

<h3>ZFail</h3>

<pre><code>    ZFail stencilOperation
</code></pre>

<p>What to do with the contents of the buffer if the stencil test passes, but the depth test fails. Default: <em>keep</em>.</p>

<p>Comp, Pass, Fail and ZFail will be applied to the front-facing geometry, unless <em>Cull Front</em> is specified, in which case it’s back-facing geometry. You can also explicitly specify the two-sided stencil state by defining CompFront, PassFront, FailFront, ZFailFront (for front-facing geometry), and CompBack, PassBack, FailBack, ZFailBack (for back-facing geometry).</p>

<h3>Comparison Function</h3>

<p>Comparison function is one of the following:</p>

<table>
<colgroup>
<col style="text-align:left;">
<col style="text-align:left;">
</colgroup>

<thead>
<tr>
	<th style="text-align:left;" colspan="2"></th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;"><strong>Greater</strong></td>
	<td style="text-align:left;">Only render pixels whose reference value is greater than the value in the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>GEqual</strong></td>
	<td style="text-align:left;">Only render pixels whose reference value is greater than or equal to the value in the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Less</strong></td>
	<td style="text-align:left;">Only render pixels whose reference value is less than the value in the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>LEqual</strong></td>
	<td style="text-align:left;">Only render pixels whose reference value is less than or equal to the value in the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Equal</strong></td>
	<td style="text-align:left;">Only render pixels whose reference value equals the value in the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>NotEqual</strong></td>
	<td style="text-align:left;">Only render pixels whose reference value differs from the value in the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Always</strong></td>
	<td style="text-align:left;">Make the stencil test always pass.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Never</strong></td>
	<td style="text-align:left;">Make the stencil test always fail.</td>
</tr>
</tbody>
</table>

<h3>Stencil Operation</h3>

<p>Stencil operation is one of the following:</p>

<table>
<colgroup>
<col style="text-align:left;">
<col style="text-align:left;">
</colgroup>

<thead>
<tr>
	<th style="text-align:left;" colspan="2"></th>
</tr>
</thead>

<tbody>
<tr>
	<td style="text-align:left;"><strong>Keep</strong></td>
	<td style="text-align:left;">Keep the current contents of the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Zero</strong></td>
	<td style="text-align:left;">Write 0 into the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Replace</strong></td>
	<td style="text-align:left;">Write the reference value into the buffer.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>IncrSat</strong></td>
	<td style="text-align:left;">Increment the current value in the buffer. If the value is 255 already, it stays at 255.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>DecrSat</strong></td>
	<td style="text-align:left;">Decrement the current value in the buffer. If the value is 0 already, it stays at 0.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>Invert</strong></td>
	<td style="text-align:left;">Negate all the bits.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>IncrWrap</strong></td>
	<td style="text-align:left;">Increment the current value in the buffer. If the value is 255 already, it becomes 0.</td>
</tr>
<tr>
	<td style="text-align:left;"><strong>DecrWrap</strong></td>
	<td style="text-align:left;">Decrement the current value in the buffer. If the value is 0 already, it becomes 255.</td>
</tr>
</tbody>
</table>

<h2>Deferred rendering path</h2>

<p>Stencil functionality for objects rendered in the deferred rendering path is somewhat limited, as during the base pass and lighting pass the stencil buffer is used for other purposes. During those two stages stencil state defined in the shader will be ignored and only taken into account during the final pass. Because of that it’s not possible to mask out these objects based on a stencil test, but they can still modify the buffer contents, to be used by objects rendered later in the frame. Objects rendered in the forward rendering path following the deferred path (e.g. transparent objects or objects without a surface shader) will set their stencil state normally again.</p>

<p>The deferred rendering path uses the three highest bits of the stencil buffer, plus up to four more highest bits - depending on how many light mask layers are used in the scene. It is possible to operate within the range of the “clean” bits using the stencil read and write masks, or you can force the camera to clean the stencil buffer after the lighting pass using Camera.clearStencilAfterLightingPass.</p>

<h3>Example</h3>

<p>The first example shader will write the value 2 wherever the depth test passes (the stencil test is set to always pass), and will decrement (and wrap) the current value to 255 if the depth test fails (assuming we’re starting off with a clear stencil buffer).</p>

<pre><code>Shader &quot;Red&quot; {
    SubShader {
        Tags { &quot;RenderType&quot;=&quot;Opaque&quot; &quot;Queue&quot;=&quot;Geometry&quot;}
        Pass {
            Stencil {
                Ref 2
                Comp always
                Pass replace
                ZFail decrWrap
            }
        
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            struct appdata {
                float4 vertex : POSITION;
            };
            struct v2f {
                float4 pos : SV_POSITION;
            };
            v2f vert(appdata v) {
                v2f o;
                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);
                return o;
            }
            half4 frag(v2f i) : SV_Target {
                return half4(1,0,0,1);
            }
            ENDCG
        }
    } 
}
</code></pre>

<p>Second shader will pass only for the pixels for which the first (red) shader passed, since it’s checking for equality with value 2. It will also decrement the value in the buffer wherever it fails the stencil test.</p>

<pre><code>Shader &quot;Green&quot; {
    SubShader {
        Tags { &quot;RenderType&quot;=&quot;Opaque&quot; &quot;Queue&quot;=&quot;Geometry+1&quot;}
        Pass {
            Stencil {
                Ref 2
                Comp equal
                Pass keep 
                Fail decrWrap 
                ZFail keep
            }
        
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            struct appdata {
                float4 vertex : POSITION;
            };
            struct v2f {
                float4 pos : SV_POSITION;
            };
            v2f vert(appdata v) {
                v2f o;
                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);
                return o;
            }
            half4 frag(v2f i) : SV_Target {
                return half4(0,1,0,1);
            }
            ENDCG
        }
    } 
}
</code></pre>

<p>The third shader will only pass wherever the stencil value was decremented twice, so for pixels, which failed the depth test in the first (red) shader and also failed the stencil test in the second (green) shader.</p>

<pre><code>Shader &quot;Blue&quot; {
    SubShader {
        Tags { &quot;RenderType&quot;=&quot;Opaque&quot; &quot;Queue&quot;=&quot;Geometry+2&quot;}
        Pass {
            Stencil {
                Ref 254
                Comp equal
            }
        
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            struct appdata {
                float4 vertex : POSITION;
            };
            struct v2f {
                float4 pos : SV_POSITION;
            };
            v2f vert(appdata v) {
                v2f o;
                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);
                return o;
            }
            half4 frag(v2f i) : SV_Target {
                return half4(0,0,1,1);
            }
            ENDCG
        }
    }
}
</code></pre>

<p>The result:</p>

<figure>
<img src="../uploads/Main/StencilExample.png" alt="">
<figcaption></figcaption></figure>

<p>Another example of a more directed effect. The sphere is first rendered with this shader to mark-up the proper regions in the stencil buffer:</p>

<pre><code>Shader &quot;HolePrepare&quot; {
    SubShader {
        Tags { &quot;RenderType&quot;=&quot;Opaque&quot; &quot;Queue&quot;=&quot;Geometry+1&quot;}
        ColorMask 0
        ZWrite off
        Stencil {
            Ref 1
            Comp always
            Pass replace
        }

        CGINCLUDE
            struct appdata {
                float4 vertex : POSITION;
            };
            struct v2f {
                float4 pos : SV_POSITION;
            };
            v2f vert(appdata v) {
                v2f o;
                o.pos = mul(UNITY_MATRIX_MVP, v.vertex);
                return o;
            }
            half4 frag(v2f i) : SV_Target {
                return half4(1,1,0,1);
            }
        ENDCG

        Pass {
            Cull Front
            ZTest Less
        
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            ENDCG
        }
        Pass {
            Cull Back
            ZTest Greater
        
            CGPROGRAM
            #pragma vertex vert
            #pragma fragment frag
            ENDCG
        }
    } 
}
</code></pre>

<p>And then rendered once more as a fairly standard surface shader, with the exception of front face culling, disabled depth test and stencil test discarding previously marked pixels:</p>

<pre><code>Shader &quot;Hole&quot; {
    Properties {
        _Color (&quot;Main Color&quot;, Color) = (1,1,1,0)
    }
    SubShader {
        Tags { &quot;RenderType&quot;=&quot;Opaque&quot; &quot;Queue&quot;=&quot;Geometry+2&quot;}

        ColorMask RGB
        Cull Front
        ZTest Always
        Stencil {
            Ref 1
            Comp notequal 
        }

        CGPROGRAM
        #pragma surface surf Lambert
        float4 _Color;
        struct Input {
            float4 color : COLOR;
        };
        void surf (Input IN, inout SurfaceOutput o) {
            o.Albedo = _Color.rgb;
            o.Normal = half3(0,0,-1);
            o.Alpha = 1;
        }
        ENDCG
    } 
}
</code></pre>

<p>The result:</p>

<figure>
<img src="../uploads/Main/StencilExample2.png" alt="">
<figcaption></figcaption></figure>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="SL-PassTags.html"></a></span><div class="tip">ShaderLab: Pass Tags</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="SL-Fog.html"></a></span><div class="tip">ShaderLab: Fog</div>
</div>
</div>
</div>
<div class="footer-wrapper"><div class="footer clear">
<div class="copy">Copyright © 2014 Unity Technologies</div>
<div class="menu">
<a href="http://unity3d.com/learn">Learn</a><a href="http://unity3d.com/community">Community</a><a href="http://unity3d.com/asset-store">Asset Store</a><a href="https://store.unity3d.com">Buy</a><a href="http://unity3d.com/unity/download">Download</a>
</div>
</div></div>
</div></div></div>
</div>
</body>
</html>
